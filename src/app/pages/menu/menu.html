<div class="container-fluid p-0">
  <header class="main-header bg-primary text-white p-3 shadow-sm">
      <h1 class="h4 mb-0 text-center"> Menu del restaurante {{ restaurantName}}</h1>
  </header>
      <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
          <div class="container">
              <a routerLink="/menu:userId" class="navbar-brand">
                  <span class="app-name fw-bold text-primary">Menú Digital</span>
              </a>
              @if (isOwner) {
                <div class="d-flex gap-2"> 
                  <button class="btn btn-success btn-sm" (click)="addNewProduct()">
                  + Agregar Producto
                  </button>
                </div>
              }
          </div>
      </nav>
  <main class="menu-container container mt-4">

    <section class="categories-nav mb-4 w-100">
      <div class="d-flex flex-row overflow-x-auto pb-2 gap-2 w-100">
        @for (cat of categories; track $index) {
          <div class="d-flex flex-column align-items-center flex-fill" style="min-width: 120px;">
            <button 
            class="btn text-nowrap w-100"
            [class.btn-success]="(currentCategoryId === cat.categoryId && currentIsDiscount === cat.isDiscount && currentIsHappyHour === (cat.isHappyHour || false))"
            [class.btn-outline-success]="!(currentCategoryId === cat.categoryId && currentIsDiscount === cat.isDiscount && currentIsHappyHour === (cat.isHappyHour || false))"
            (click) = "selectcategory(cat.categoryId, cat.isDiscount, cat.isHappyHour || false)">
            {{ cat.name }}
            </button>
            @if (isOwner && cat.categoryId !== undefined) {
              <div class="mt-1 d-flex gap-1 w-100 justify-content-center">
                <button class="btn btn-sm btn-light border text-primary py-0" (click)="editCategory(cat)" title="Editar">
                  <small><i class="bi bi-pencil"></i>Editar</small>
                </button>
                <button class="btn btn-sm btn-light border text-danger py-0" (click)="deleteCategory(cat.categoryId)" title="Eliminar">
                  <small><i class="bi bi-trash"></i>Eliminar</small>
                </button>
              </div>
            }
          </div>
        }
      </div>
    </section>

      @if (isLoading){
          <div class="spinner-area text-center py-5">
              <app-spinner></app-spinner>
          </div>
      } @else {
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 products-list">
        @for (item of menu; track $index) {
          <div class="col">
            <app-product-card 
              [product]="item" 
              (viewDetail)="openDetail($event)">
            </app-product-card>

            @if (isOwner) {
              <div class="d-flex justify-content-end gap-2 mt-2 px-2 rounded">
                <button class="btn btn-sm btn-outline-primary" (click)="openEditProduct(item)">Editar</button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteProduct(item.id)">Eliminar</button>
              </div>
            }
          </div>
        } @empty {
          <div class="col-12">
            <p class="alert alert-info text-center">No se encontraron productos.</p>
          </div>
        }
      </div>
    }
  </main>
</div>
@if (selectedProduct) {
  <app-product-detail-modal 
    [product]="selectedProduct!" 
    (close)="closeDetail()">
  </app-product-detail-modal>
}

@if (showCategoryForm) {
  <div class="modal-backdrop fade show"></div>
  <div class="modal d-block show" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <app-categories 
          [categoryIdToEdit]="categoryIdSelected">
        </app-categories>
        <div class="p-3 text-center">
          <button class="btn btn-secondary w-100" (click)="showCategoryForm = false">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showProductForm) {
  <div class="modal-backdrop fade show"></div>
  <div class="modal d-block show" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">{{ productToEdit ? 'Editar Producto' : 'Nuevo Producto' }}</h5>
          <button type="button" class="btn-close btn-close-white" (click)="showProductForm = false"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre del plato</label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.nombre" placeholder="Ej: Milanesa a caballo">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Precio $</label>
            <input type="number" class="form-control" [(ngModel)]="nuevoProducto.precio" placeholder="0.00">
          </div>
          <div class = "row mb-3">
            <div class="col-6">
              <label class="form-label fw-bold text-danger">Descuento%</label>
              <input type="number" class="form-control" [(ngModel)]="nuevoProducto.discount" placeholder="Ej: 10" max="100">
            </div>
            <div class="col-6 d-flex align-items-center pt-4">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="happyHourSwitch" [(ngModel)]="nuevoProducto.happyHour">
                <label class="form-check-label fw-bold text-primary" for="happyHourSwitch">
                  HappyHour
                </label>
              </div>
            </div>
          </div>
          <div class="mb-3 p-3 bg-light border rounded">
            <label class="form-label fw-bold text-primary">Categoría</label>
            @if (!usarNuevaCategoria) {
              <select [(ngModel)]="nuevoProducto.categoryId" class="form-select mb-2">
                <option [ngValue]="undefined">Seleccione una categoría...</option>
                @for (cat of categories; track $index) {
                  @if(cat.categoryId) {
                    <option [value]="cat.categoryId">{{ cat.name }}</option>
                  }
                }
              </select>
            }

            @if (usarNuevaCategoria) {
              <div class="mb-2">
                <input type="text" 
                       [(ngModel)]="nombreNuevaCategoria" 
                       class="form-control border-success" 
                       placeholder="Escribe el nombre de la nueva categoría...">
              </div>
            }

            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="checkNuevaCat" [(ngModel)]="usarNuevaCategoria">
              <label class="form-check-label text-muted small" for="checkNuevaCat">
                {{ usarNuevaCategoria ? 'Cancelar creación (Usar existente)' : 'Quiero crear una categoría nueva ahora mismo' }}
              </label>
            </div>
          </div>

          <button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" (click)="guardarCambios()">
            Guardar Producto
          </button>
        </div>
      </div>
    </div>
  </div>
}